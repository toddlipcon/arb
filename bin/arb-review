#!/usr/bin/perl

use strict;
use warnings;
use FindBin;
use lib "$FindBin::Bin/../perllib/";

use Data::Dumper qw/Dumper/;

use ARB;

print "\nFetching newest main...\n";

system('git-fetch',
       'main');

print "\nComputing revision list for review\n";

my @rev_list = &compute_list_for_review('refs/remotes/main/master');

print "Creating review on review system...\n";

my $review = ARB::create_review();

print "Created review id " . $review->{id} . "\n";

my $review_branch = 'review-' . $review->{id};

print "Creating review branch $review_branch...\n";

system('git-checkout',
       '-b',
       $review_branch);

print "\nPushing review branch to review repository";

system("git-push",
       ARB::get_review_repository(),
       $review_branch);


print "\nInserting revisions into review...\n";

foreach my $rev (@rev_list) {
    print "Inserting revision $rev...";
    ARB::add_commit_to_review($rev, $review->{id});
    print "done\n";
}

print "Review is complete. You can see it at:\n";
print ARB::get_review_url($review->{id});


sub compute_list_for_review {
    my ($destination) = @_;
    open(REV_LIST, "-|", "git-rev-list", 'HEAD', '^' . $destination)
        || die "Couldnt open pipe to git-rev-list: $!";
    chomp(my @revs = <REV_LIST>);
    close(REV_LIST);

    return @revs;
}
